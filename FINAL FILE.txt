#include <AS726X.h>


#include <LiquidCrystal.h>
#include "AS726X.h"
//#include "Arduino.h"
 
#include <SoftwareSerial.h>
#include <stdlib.h>



AS726X sensor;
const int rs = 12, en = 13, d4 = 8, d5 = 9 ,d6 =10, d7 = 11;
LiquidCrystal lcd(rs, en, d4, d5, d6, d7);
String apiKey = "O4YXL90R0KBIOPUQ";

SoftwareSerial ser(5,6); // RX, TX

void setup() {  
  sensor.begin();
  pinMode(2,INPUT);
  pinMode(3,INPUT);
  pinMode(4,INPUT);
  lcd.begin(16, 2); 
 lcd.setCursor(1, 0);
   lcd.print("Plastic Sorter");
   delay(1000);
   Serial.begin(115200);
   ser.begin(9600);
ser.println("AT+RST");  
}

  void loop() {       
  unsigned int a1,i,a,b,c1;
  int d=LOW,e=LOW,f=LOW;
   lol:
       lcd.setCursor(1, 1);
  lcd.print("sensor intailzing");


    d=digitalRead(2);
  e=digitalRead(3);
  f=digitalRead(4);
  //sensor.getR()=0;
  Serial.println("start");
 /* if(d==HIGH && e==LOW && f==LOW)
  {  
    Serial.println("start1"); 
  for(i=0;i<=100;i++)
  {
sensor.enableBulb();
  a=a+sensor.getR();
   b=b+sensor.getS();
   sensor.disableBulb();

 //sensor.printMeasurements();
  }
 delay(4000);
  a=a/101;
  b=b/101;
  Serial.println("r=");
  Serial.print(a);
  Serial.println("s=");
  Serial.print(b);
   // a=0;
 // b=0;
  lcd.clear();
   lcd.setCursor(1, 0);
   lcd.print("leaf predictor");
  if(a>47)
  {
      
       lcd.setCursor(1, 1);
       lcd.print("It is affected");
          delay(1000);
          Serial.print("bad leaf");
          
 
  }
  else 
  {
    lcd.setCursor(1, 1);
       lcd.print("It is healthy leaf");
       
       delay(1000);
       Serial.print("good leaf");
  }
  }

  
  else if(e==HIGH)
  {   
    Serial.println("start2");
  for(i=0;i<=100;i++)
  {
sensor.enableBulb();
  a=a+sensor.getR();
   b=b+sensor.getS();
   sensor.disableBulb();

 //sensor.Measurements();
  }
 delay(4000);
  a=a/101;
  b=b/101;
  Serial.println("r=");
  Serial.print(a);
  Serial.println("s=");
  Serial.print(b);
    a=0;
  b=0;
  lcd.clear();
   lcd.setCursor(1, 0);
   lcd.print("leaf predictor");
  if(a>47)
  {
      
       lcd.setCursor(1, 1);
       lcd.print("It is affected");
          delay(1000);
          Serial.print("bad leaf");
          
 
  }
  else 
  {
    lcd.setCursor(1, 1);
       lcd.print("It is healthy leaf");
       
       delay(1000);
       Serial.print("good leaf");
  }
  e==LOW;
  }

  
  else if(f==HIGH)
  {  */ 
    Serial.println("start3");
    

  for(i=0;i<=10;i++)
  {
    
sensor.enableBulb();
sensor.takeMeasurements();
  a=a+sensor.getR();
  //Serial.println(sensor.getR());
   b=b+sensor.getS();
   sensor.disableBulb();

 //sensor.printMeasurements();
  }
 //delay(4000);
  a=a/11;
  b=b/11;
  Serial.println("r=");
  Serial.print(a);
  Serial.println("s=");
  Serial.print(b);
    
  lcd.clear();
   lcd.setCursor(0, 0);
   lcd.print("leaf predictor");
  if(a>47)
  {
      lcd.clear();
       lcd.setCursor(0, 1);
       lcd.print("It is affected");
          delay(10000);
          Serial.print("bad leaf");
          
 
  }
  else 
  {
    lcd.setCursor(1, 1);
       lcd.print("It is healthy leaf");
       
       delay(10000);
       Serial.print("good leaf");
  }
//}
  
  char buf[16],m[16];
   String stra1 = dtostrf(a, 4, 1, buf);

 Serial.println(a1);
 // String strc1 = dtostrf(b, 4, 1, m);
  
 // Serial.println(c1);


    
     
  //delay(10000);
  // TCP connection
  String cmd = "AT+CIPSTART=\"TCP\",\"";
  cmd += "184.106.153.149"; // api.thingspeak.com
  cmd += "\",80";
  ser.println(cmd);

  if(ser.find("Error")){
    Serial.println("AT+CIPSTART error");
    goto lol;
    return;
  }

  // prepare GET string
  String getStr = "GET /update?api_key=";
  getStr += apiKey;
  getStr +="&field1=";
  getStr += String(a);
  getStr +="&field2=";
  getStr += String(b);
  
  getStr += "\r\n\r\n";

  // send data length
  cmd = "AT+CIPSEND=";
  cmd += String(getStr.length());
  ser.println(cmd);

  if(ser.find(">")){
    ser.print(getStr);
  }
  else{
    ser.println("AT+CIPCLOSE");
   //goto lol;
    Serial.println("AT+CIPCLOSE");
  }

   lcd.setCursor(1, 1);
       lcd.print("wait for 15s");
       
  delay(16000);  
      
  a=0;
  b=0;
}
